<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wizard's Tower</title>
    <link rel="stylesheet" href="/styles/mapStyle.css">
    <script src="/scripts/mapManager.js"></script>
    <style>
        /* Center the entire container */
body, html {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
    margin: 0;
    font-family: Arial, sans-serif;
}

.map-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

/* Center the image container */
.image-container {
    overflow: scroll;
    width: 100vw;
    height: 1000px;
    position: relative;
    display: inline-block;
    background-color: black;
}

/* Basic styles for contained image */
#mainImage {
    width: 250%;
    height: auto;
}

#mainImage.wizardTower {
    width: 50%;
}

/* Style for square markers */
.square {
    position: absolute;
    width: 60px;
    height: 60px;
    cursor: pointer;
    border: medium solid white;
}

/* Remove button on markers */
.remove-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 12px;
    height: 12px;
    background-color: white;
    color: red;
    border-radius: 50%;
    border: 1px solid darkred;
    font-size: 10px;
    text-align: center;
    line-height: 12px;
    cursor: pointer;
    display: none;
}

.square:hover .remove-btn {
    display: block;
}

/* Style for marker menu */
.square-menu {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 20px;
    align-items: center;
    justify-content: center;
    max-width: 800px;
}

/* Marker menu styling */
.menu-square {
    width: 50px;
    height: 50px;
    cursor: pointer;
    border: 1px solid #000;
}

/* Hero styling */
.liten {
    background: url(/images/liten.png) no-repeat center;
    background-size: contain;
    background-color: white;
}
.munnin {
    background: url(/images/munnin.png) no-repeat center;
    background-size: contain;
    background-color: white;
}
.ratKing {
    background: url(/images/dingo.png) no-repeat center;
    background-size: contain;
    background-color: blue;
}
.saytar {
    background: url(/images/dingo.png) no-repeat center;
    background-size: contain;
    background-color: red;
}

/* NPC styling */
.clint {
    background: url(/images/clint.png) no-repeat center;
    background-size: contain;
    background-color: white;
}
.evelyn {
    background: url(/images/evelyn.png) no-repeat center;
    background-size: contain;
    background-color: white;
}
.elliot {
    background: url(/images/elliot.png) no-repeat center;
    background-size: contain;
    background-color: white;
}
.gunther {
    background: url(/images/gunther.png) no-repeat center;
    background-size: contain;
    background-color: white;
}
.gus {
    background: url(/images/gus.png) no-repeat center;
    background-size: contain;
    background-color: white;
}
.harvey {
    background: url(/images/harvey.png) no-repeat center;
    background-size: contain;
    background-color: white;
}
.honeyBear {
    background: url(/images/honeyBear.png) no-repeat center;
    background-size: contain;
    background-color: white;
}
.kent {
    background: url(/images/kent.png) no-repeat center;
    background-size: contain;
    background-color: white;
}
.linus {
    background: url(/images/linus.png) no-repeat center;
    background-size: contain;
    background-color: white;
}
.mayorLewis {
    background: url(/images/mayorLewis.png) no-repeat center;
    background-size: contain;
    background-color: white;
}
.morris {
    background: url(/images/morris.png) no-repeat center;
    background-size: contain;
    background-color: white;
}
.mrWhite {
    background: url(/images/mrWhite.png) no-repeat center;
    background-size: contain;
    background-color: white;
}
.pierre {
    background: url(/images/pierre.png) no-repeat center;
    background-size: contain;
    background-color: white;
}
.robyn {
    background: url(/images/robyn.png) no-repeat center;
    background-size: contain;
    background-color: white;
}
.theWizard {
    background: url(/images/theWizard.png) no-repeat center;
    background-size: contain;
    background-color: white;
}

/* Monster styling */
.mummy {
    background: url(/images/mummy.png) no-repeat center;
    background-size: contain;
    background-color: white;
}
.rustMonster {
    background: url(/images/rustMonster.png) no-repeat center;
    background-size: contain;
    background-color: white;
}
.skeleton {
    background: url(/images/skeleton.png) no-repeat center;
    background-size: contain;
    background-color: white;
}

.active { outline: 3px solid #333; }

/* Button styles */
.button-container {
    display: flex;
    justify-content: center;
    width: 100%;
    margin-top: 10px;
}

.clear-button, .save-button {
    padding: 5px 10px;
    cursor: pointer;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    margin: 0 5px;
}
.clear-button { background-color: #f44336; }
.save-button { background-color: #4CAF50; }

    </style>
</head>
<body>
    <div class="map-container" id="mapContainer">
        <div class="image-container" id="imageContainer">
            <img src="/images/wizardsTower.jpg" alt="Clickable Image" id="mainImage" class="wizardTower">
        </div>
        <!-- PC markers -->
        <div class="square-menu" id="squareMenu1">
            <div class="menu-square liten" data-style="liten" title="Liten"></div>
            <div class="menu-square munnin" data-style="munnin" title="Munnin Uvennlig"></div>
            <div class="menu-square ratKing" data-style="ratKing" title="Rat King"></div>
            <div class="menu-square saytar" data-style="saytar" title="Saytar"></div>
            <div class="button-container">
                <button class="clear-button" id="clearButton1">Clear All</button>
                <button class="save-button" id="saveButton1">Save Markers</button>
            </div>
        </div>
        <!-- NPC markers -->
        <div class="square-menu" id="squareMenu2">
            <div class="menu-square clint" data-style="clint" title="Clint"></div>
            <div class="menu-square evelyn" data-style="evelyn" title="Evelyn"></div>
            <div class="menu-square elliot" data-style="elliot" title="Elliot"></div>
            <div class="menu-square gunther" data-style="gunther" title="Gunther"></div>
            <div class="menu-square gus" data-style="gus" title="Gus"></div>
            <div class="menu-square harvey" data-style="harvey" title="Harvey"></div>
            <div class="menu-square honeyBear" data-style="honeyBear" title="Honey Bear"></div>
            <div class="menu-square kent" data-style="kent" title="Kent"></div>
            <div class="menu-square linus" data-style="linus" title="Linus"></div>
            <div class="menu-square mayorLewis" data-style="mayorLewis" title="Mayor Lewis"></div>
            <div class="menu-square morris" data-style="morris" title="Morris"></div>
            <div class="menu-square mrWhite" data-style="mrWhite" title="Mr. White"></div>
            <div class="menu-square pierre" data-style="pierre" title="Pierre"></div>
            <div class="menu-square robyn" data-style="robyn" title="Robyn"></div>
            <div class="menu-square theWizard" data-style="theWizard" title="The Wizard"></div>
            <div class="button-container">
                <button class="clear-button" id="clearButton2">Clear All</button>
            </div>
        </div>
        <!-- Monster markers -->
        <div class="square-menu" id="squareMenu3">
            <div class="menu-square mummy" data-style="mummy" title="Mummy"></div>
            <div class="menu-square rustMonster" data-style="rustMonster" title="Rust Monster"></div>
            <div class="menu-square skeleton" data-style="skeleton" title="Skeleton"></div>
            <div class="button-container">
                <button class="clear-button" id="clearButton3">Clear All</button>
            </div>
        </div>
    </div>
    <script>
        function main() {
    const imageContainer = document.getElementById('imageContainer');
    const mainImage = document.getElementById('mainImage');
    let selectedSquareStyle = 'liten';
    const placedSquares1 = {};
    const placedSquares2 = {};
    const placedSquares3 = {};

    // Get a unique key for each origin
    let origin = `${window.location.href.substring(window.location.href.lastIndexOf("/") + 1,window.location.href.length - 5)}_`;

    // Function to create or update a square
    function createOrUpdateSquare(x, y, style, placedSquares) {
        let square;
        if (placedSquares[style]) {
            square = placedSquares[style];
            square.style.left = `${x}px`;
            square.style.top = `${y}px`;
        } else {
            square = document.createElement('div');
            square.classList.add('square', style);
            square.style.left = `${x}px`;
            square.style.top = `${y}px`;

            const removeBtn = document.createElement('div');
            removeBtn.classList.add('remove-btn');
            removeBtn.textContent = 'X';
            removeBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                square.remove();
                delete placedSquares[style];
                saveMarkers();
            });

            square.appendChild(removeBtn);
            imageContainer.appendChild(square);
            placedSquares[style] = square;
        }
    }

    function saveMarkers() {
        const markers1 = Object.entries(placedSquares1).map(([style, square]) => {
            const rect = square.getBoundingClientRect();
            const offsetX = rect.left - imageContainer.getBoundingClientRect().left;
            const offsetY = rect.top - imageContainer.getBoundingClientRect().top;
            return { style, x: offsetX, y: offsetY };
        });
        const markers2 = Object.entries(placedSquares2).map(([style, square]) => {
            const rect = square.getBoundingClientRect();
            const offsetX = rect.left - imageContainer.getBoundingClientRect().left;
            const offsetY = rect.top - imageContainer.getBoundingClientRect().top;
            return { style, x: offsetX, y: offsetY };
        });
        const markers3 = Object.entries(placedSquares3).map(([style, square]) => {
            const rect = square.getBoundingClientRect();
            const offsetX = rect.left - imageContainer.getBoundingClientRect().left;
            const offsetY = rect.top - imageContainer.getBoundingClientRect().top;
            return { style, x: offsetX, y: offsetY };
        });
        localStorage.setItem(origin + 'markers1', JSON.stringify(markers1));
        localStorage.setItem(origin + 'markers2', JSON.stringify(markers2));
        localStorage.setItem(origin + 'markers3', JSON.stringify(markers3));
    }

    function loadMarkers(placedSquares, storageKey) {
        const markers = JSON.parse(localStorage.getItem(origin + storageKey));
        if (markers) {
            markers.forEach(marker => {
                createOrUpdateSquare(marker.x, marker.y, marker.style, placedSquares);
            });
        }
    }

    // Function to deselect all menu squares
    function deselectAllMenus() {
        document.querySelectorAll('.menu-square').forEach(square => square.classList.remove('active'));
    }

    // Menu event listeners with cross-menu deselection
    document.getElementById('squareMenu1').addEventListener('click', (event) => {
        if (event.target.classList.contains('menu-square')) {
            deselectAllMenus();
            selectedSquareStyle = event.target.getAttribute('data-style');
            event.target.classList.add('active');
        }
    });

    document.getElementById('squareMenu2').addEventListener('click', (event) => {
        if (event.target.classList.contains('menu-square')) {
            deselectAllMenus();
            selectedSquareStyle = event.target.getAttribute('data-style');
            event.target.classList.add('active');
        }
    });

    document.getElementById('squareMenu3').addEventListener('click', (event) => {
        if (event.target.classList.contains('menu-square')) {
            deselectAllMenus();
            selectedSquareStyle = event.target.getAttribute('data-style');
            event.target.classList.add('active');
        }
    });

    imageContainer.addEventListener('click', (event) => {
    const rect = mainImage.getBoundingClientRect();
    const containerRect = imageContainer.getBoundingClientRect();

    // Calculate the scaling factors for both dimensions
    console.log("image native size: " + mainImage.naturalWidth + " x " + mainImage.naturalHeight);
    const scaleX = rect.width / mainImage.naturalWidth;
    const scaleY = rect.height / mainImage.naturalHeight;
    console.log("image scale, w x h: " + scaleX + ", " + scaleY);

    // Calculate the relative position of the click within the scaled image
    const x = (event.clientX - rect.left) / scaleX - 25;
    const y = (event.clientY - rect.top) / scaleY - 25;
    console.log("scaled x/y: " + x + "/" + y);

    if (document.querySelector('#squareMenu1 .active')) {
        createOrUpdateSquare(x, y, selectedSquareStyle, placedSquares1);
    } else if (document.querySelector('#squareMenu2 .active')) {
        createOrUpdateSquare(x, y, selectedSquareStyle, placedSquares2);
    } else if (document.querySelector('#squareMenu3 .active')) {
        createOrUpdateSquare(x, y, selectedSquareStyle, placedSquares3);
    }
});

    // Clear buttons
    document.getElementById('clearButton1').addEventListener('click', () => {
        for (const style in placedSquares1) {
            placedSquares1[style].remove();
            delete placedSquares1[style];
        }
        localStorage.removeItem(origin + 'markers1');
    });

    document.getElementById('clearButton2').addEventListener('click', () => {
        for (const style in placedSquares2) {
            placedSquares2[style].remove();
            delete placedSquares2[style];
        }
        localStorage.removeItem(origin + 'markers2');
    });

    document.getElementById('clearButton3').addEventListener('click', () => {
        for (const style in placedSquares3) {
            placedSquares3[style].remove();
            delete placedSquares3[style];
        }
        localStorage.removeItem(origin + 'markers3');
    });

    // Save buttons
    document.getElementById('saveButton1').addEventListener('click', saveMarkers);

    window.onload = () => {
        loadMarkers(placedSquares1, 'markers1');
        loadMarkers(placedSquares2, 'markers2');
        loadMarkers(placedSquares3, 'markers3');
    };
}

        main();
    </script>
</body>
</html>
